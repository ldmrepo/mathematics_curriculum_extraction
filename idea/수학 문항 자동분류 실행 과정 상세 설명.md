## 🔄 **수학 문항 자동분류 실행 과정 상세 설명**

### **1. 문항 입력 및 초기 처리**

#### **1.1 입력 수신**
```
입력 형태:
- 단일 문항: 텍스트 직접 입력
- 배치 처리: Excel/CSV 파일 업로드
- API 호출: JSON 형식 요청

입력 예시:
"두 자리 수 45와 37의 합을 구하고, 
그 결과가 짝수인지 홀수인지 판별하시오."
```

#### **1.2 전처리 과정**
```
텍스트 정규화:
1. 인코딩 통일 (UTF-8)
2. 특수문자 표준화
3. 띄어쓰기 정규화
4. 줄바꿈 처리

수식 처리:
- LaTeX 수식 감지 및 파싱
- 한글 수식 표현 통일
- 수학 기호 표준화
```

---

### **2. 문항 복잡도 분석**

#### **2.1 복잡도 평가 기준**
```
평가 요소:
1. 텍스트 길이 (단어 수)
2. 문장 구조 복잡도
3. 수학 개념 개수
4. 다단계 문제 여부
5. 그림/도형 포함 여부

분류 결과:
- Simple (단순): 단일 개념, 직접 계산
- Medium (중간): 2-3개 개념, 2단계 해결
- Complex (복잡): 다중 개념, 3단계 이상
```

#### **2.2 복잡도별 처리 전략 결정**
```
Simple → 빠른 벡터 검색 중심
Medium → 균형잡힌 하이브리드 검색
Complex → 그래프 기반 심층 분석
```

---

### **3. 하이브리드 검색 실행**

#### **3.1 벡터 검색 (Vector RAG)**

##### **Step 1: 쿼리 임베딩 생성**
```
입력 문항 → 한국어 임베딩 모델 → 384차원 벡터

사용 모델: ko-sbert-sts
처리 시간: ~50ms
```

##### **Step 2: 유사도 검색**
```
FAISS 인덱스 검색:
- 검색 대상: 1,024개 문서 (181 성취기준 + 843 성취수준)
- 검색 방법: 코사인 유사도
- 결과: Top-K 문서 (K=5~10)

반환 정보:
1. 유사 성취기준 3개
2. 유사 성취수준 5개
3. 각 문서의 유사도 점수
```

#### **3.2 그래프 검색 (Graph RAG)**

##### **Step 1: 키워드 추출**
```
문항에서 핵심 개념 추출:
- "두 자리 수" → 수 개념
- "합" → 덧셈
- "짝수/홀수" → 수의 성질

추출 방법:
1. 수학 용어 사전 매칭
2. 형태소 분석 (명사 추출)
3. TF-IDF 가중치 계산
```

##### **Step 2: 그래프 탐색**
```
시작점 결정:
- 추출된 키워드와 매칭되는 노드 찾기
- 예: "덧셈" → [2수01-04] 노드

탐색 전략:
1. BFS로 1-hop 이웃 노드 탐색
2. 2-hop까지 확장 (필요시)
3. 경로 가중치 계산

수집 정보:
- 관련 성취기준 노드
- 연결된 성취수준 노드
- 선수학습 관계
- 커뮤니티 정보
```

##### **Step 3: 커뮤니티 컨텍스트**
```
관련 커뮤니티 식별:
1. 노드가 속한 커뮤니티 확인
2. 커뮤니티 요약 정보 추출
3. 상위 레벨 커뮤니티 확인

예시:
Level 0: "초등 수와 연산 기초"
Level 1: "덧셈과 뺄셈"
Level 2: "두 자리 수 연산"
```

#### **3.3 검색 결과 통합**

##### **통합 과정**
```
벡터 검색 결과 (40%):
- [2수01-04] 두 자리 수 덧셈 (유사도: 0.85)
- [2수01-05] 덧셈과 뺄셈 관계 (유사도: 0.72)

그래프 검색 결과 (60%):
- [2수01-04] + 주변 노드 컨텍스트
- 선수학습: [2수01-01] 수 개념
- 후속학습: [4수01-02] 곱셈

가중 평균으로 최종 점수 계산
```

---

### **4. LLM 기반 분류 실행**

#### **4.1 컨텍스트 구성**

##### **프롬프트 구조**
```
시스템 프롬프트:
"당신은 2022 개정 수학과 교육과정 전문가입니다."

컨텍스트 섹션:
=== 검색된 성취기준 ===
1. [2수01-04] 두 자리 수의 덧셈과 뺄셈
   - 내용: 두 자리 수 범위에서 덧셈과 뺄셈 계산
   - 유사도: 0.85

=== 관련 성취수준 ===
- A수준: 받아올림이 있는 두 자리 수 덧셈을 
        능숙하게 계산하고 설명할 수 있다
- B수준: 두 자리 수 덧셈을 계산할 수 있다
- C수준: 구체물을 사용하여 덧셈을 이해한다

=== 그래프 컨텍스트 ===
- 소속 커뮤니티: "초등 저학년 수 연산"
- 선수학습: 한 자리 수 덧셈
- 관련 개념: 자리값, 받아올림

문항:
"두 자리 수 45와 37의 합을 구하고..."
```

#### **4.2 LLM 추론 과정**

##### **모델별 처리**
```
OpenAI GPT-4:
- 추론 시간: ~2초
- Chain of Thought 활성화
- Temperature: 0.2 (일관성 우선)

Claude 3.5:
- 추론 시간: ~1.5초
- 구조화된 출력 요청
- 검증 로직 포함

Gemini Pro:
- 추론 시간: ~1초
- JSON 모드 활성화
- 빠른 응답 우선
```

##### **추론 단계**
```
LLM 내부 추론 과정:
1. 문항 핵심 개념 파악
   → "두 자리 수 덧셈" + "짝수/홀수 판별"

2. 검색 결과와 매칭
   → [2수01-04]가 가장 적합

3. 성취수준 판단
   → 추가 개념(짝수/홀수) 포함으로 B수준

4. 최종 분류 결정
```

#### **4.3 앙상블 투표**

##### **가중 투표 메커니즘**
```
모델별 응답:
- GPT-4: [2수01-04], B수준 (가중치: 0.4)
- Claude: [2수01-04], B수준 (가중치: 0.4)
- Gemini: [2수01-04], A수준 (가중치: 0.2)

투표 결과:
- 성취기준: [2수01-04] (100% 일치)
- 성취수준: B (80% vs A 20%)
- 신뢰도: 0.93 (높은 일치도)
```

---

### **5. 후처리 및 검증**

#### **5.1 결과 검증**

##### **유효성 검사**
```
1. 성취기준 코드 존재 여부 확인
2. 학년-영역 일관성 검증
3. 성취수준 적합성 확인

오류 시 처리:
- 가장 유사한 유효 코드로 수정
- 재분류 시도 (다른 전략)
- 수동 검토 큐에 추가
```

##### **일관성 검증**
```
검증 항목:
- 학년군과 영역 매칭 확인
- 난이도와 성취수준 일치성
- 선수학습 요구사항 충족
```

#### **5.2 설명 생성**

##### **분류 근거 작성**
```
자동 생성 설명:
"이 문항은 두 자리 수의 덧셈을 다루며(핵심 개념),
추가로 수의 성질(짝수/홀수) 판별을 요구합니다.
기본 연산에 추가 개념이 포함되어 B수준으로 
분류되었습니다. 관련 선수학습으로는 
한 자리 수 덧셈과 수의 분류가 필요합니다."
```

---

### **6. 최종 결과 출력**

#### **6.1 구조화된 결과**
```json
{
  "problem": "두 자리 수 45와 37의 합을 구하고...",
  "classification": {
    "grade_level": "초1-2",
    "domain": "수와 연산",
    "achievement_standard": {
      "code": "[2수01-04]",
      "title": "두 자리 수의 덧셈과 뺄셈",
      "content": "두 자리 수 범위에서..."
    },
    "achievement_level": "B",
    "difficulty": 2,
    "key_concepts": ["덧셈", "두 자리 수", "짝수/홀수"],
    "cognitive_level": "이해 및 적용"
  },
  "metadata": {
    "confidence": 0.93,
    "processing_time": 3.2,
    "strategy_used": "balanced",
    "models_agreed": true
  },
  "explanation": {
    "reasoning": "...",
    "prerequisites": ["한 자리 수 덧셈", "수의 분류"],
    "next_concepts": ["세 자리 수 덧셈", "받아올림"],
    "teaching_tips": "구체물 활용 후 추상화 권장"
  }
}
```

#### **6.2 시각화 정보**
```
제공 가능한 시각화:
1. 지식 그래프 상 위치 표시
2. 학습 경로 다이어그램
3. 관련 개념 네트워크
4. 난이도 분포 차트
```

---

### **7. 성능 메트릭**

#### **7.1 처리 시간 분석**
```
단계별 소요 시간:
- 전처리: 50ms
- 벡터 검색: 100ms
- 그래프 검색: 150ms
- LLM 추론: 2000ms
- 후처리: 100ms
총 처리 시간: ~2.4초
```

#### **7.2 정확도 추적**
```
실시간 모니터링:
- 분류 정확도: 92.3%
- 학년 정확도: 95.1%
- 영역 정확도: 94.7%
- 성취기준 정확도: 89.2%
- 성취수준 정확도: 86.5%
```

---

### **8. 예외 처리 및 에러 핸들링**

#### **8.1 일반적인 예외 상황**
```
상황별 처리:
1. 문항 텍스트 불명확
   → 사용자에게 재입력 요청

2. 검색 결과 부족
   → 검색 범위 확대, K값 증가

3. LLM 응답 실패
   → 다른 모델로 폴백

4. 낮은 신뢰도 (<0.6)
   → 수동 검토 큐로 전송
```

#### **8.2 특수 케이스 처리**
```
융합 문항:
- 여러 영역 걸친 문항
- 다중 성취기준 매핑
- 주/부 분류 구분

신유형 문항:
- 기존 패턴 벗어남
- 유사도 낮음
- 전문가 검토 필요
```

---

### **9. 피드백 및 학습**

#### **9.1 사용자 피드백 처리**
```
피드백 수집:
1. 분류 정확도 평가 (O/X)
2. 수정 제안 수집
3. 오분류 원인 기록

피드백 활용:
- 오분류 패턴 분석
- 프롬프트 개선
- 가중치 조정
```

#### **9.2 지속적 개선**
```
개선 사이클:
1. 주간 성능 리포트 생성
2. 오분류 사례 분석
3. 모델/전략 조정
4. A/B 테스트 실행
5. 개선 효과 측정
```

이러한 체계적인 실행 과정을 통해 입력된 수학 문항이 정확하고 신속하게 교육과정 기준에 따라 분류됩니다. 각 단계는 독립적으로 최적화되어 있으면서도 전체적으로 통합된 파이프라인을 구성합니다.