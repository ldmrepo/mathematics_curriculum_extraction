# 수학과 교육과정 데이터 설명서 v1.3 (Edges & RAG)

* 문서버전: **v1.3.0**
* 스키마: **v1.2.0 + Patch v1.3.0(Edges & RAG)**
* 최종수정: 2025-08-22
* 대상 DB: `mathematics_curriculum` (스키마: `curriculum`)

---

## 1. 개요

이 문서는 2022 개정 수학과 교육과정 데이터베이스의 구조, 데이터 파일 규칙, 로딩 절차, 조회 뷰/함수, 권한 및 운영 방법을 정리한 **개발·운영 가이드**입니다. v1.3.0 패치로 **표준 간 엣지(선행/수평)**, **표준-용어 연결**, **표상(Representation)**, **문맥/역량 태깅**, **RAG 친화 뷰/함수**가 추가되었습니다.

---

## 2. 시스템 구성 (Docker)

* **서비스**: `postgres(5432)`, `pgadmin(5050)`
* **네트워크**: `database_curriculum-net`
* **초기화 스크립트**: `/docker-entrypoint-initdb.d/`

  * `00-create-roles.sh` : DB/롤 생성
  * `01-schema-v1.2.0.sql` : 기본 스키마/테이블/뷰/함수
  * `02-patch-v1.3.0.sql` : 엣지&메타 확장(표상/용어링크/선행그래프 등)

### 빠른 실행 순서

1. `docker compose up -d`
2. 로그 확인: `docker compose logs --no-color postgres`
3. pgAdmin 접속: [http://localhost:5050](http://localhost:5050) (이메일/비번은 `.env`)
4. 서버 등록 예시

   * Host: **postgres**(동일 네트워크) 또는 **localhost**(호스트)
   * Port: **5432**, DB: `mathematics_curriculum`
   * User/Pass: `curriculum`/`curriculum`(예시)
5. 데이터 로딩: `python scripts/data_load.py`

---

## 3. 데이터 디렉터리 규칙

```
/ data
  ├─ reference/           # 기준 데이터(CSV)
  │   ├─ school_levels.csv
  │   ├─ domains.csv
  │   └─ categories.csv
  ├─ content_system/
  │   ├─ content_elements_*.csv
  │   └─ core_ideas.csv
  ├─ achievement_standards/
  │   ├─ achievement_standards_*.csv
  │   └─ standard_explanations_*.csv
  ├─ achievement_levels/
  │   └─ achievement_levels_*.csv
  └─ terms_symbols/
      └─ terms_symbols_*.csv
```

* CSV 인코딩: `UTF-8`(BOM 허용)
* 파일명 패턴은 학교급/영역을 반영하며 스크립트에서 자동 탐색합니다.

---

## 4. 스키마 개요 (주요 테이블)

> 스키마: `curriculum` (모든 테이블/뷰는 여기에 생성)

### 4.1 기준(Reference)

* **school\_levels**: 학년군/학교급 (PK `level_id`)

  * `school_type`(초/중/고), `grade_range`(예: "초1-2"), `grade_start`, `grade_end`, `level_code`(2/4/6/9/12)
* **domains**: 영역 (PK `domain_id`)

  * `domain_name`, `domain_code`(01/02/03/04), `domain_order`, `description`
* **categories**: 범주 (PK `category_id`)

  * `category_name`(지식·이해/과정·기능/가치·태도), `category_order`, `description`
* **achievement\_levels**: 성취수준 코드 (PK `level_code` = A/B/C/D/E)

  * `level_name`, `level_order`, `description`

### 4.2 내용 체계

* **core\_ideas**: 핵심 아이디어 (PK `idea_id`) → `domain_id`, `idea_content`, `idea_order`
* **content\_elements**: 내용 요소 (PK `element_id`)

  * `domain_id`, `level_id`, `category_id`, `element_name`, `element_description`, `element_order`
* **learning\_elements**: 학습 요소 (PK `learning_id`) *※ 현재 데이터 로더 미사용(향후)*

### 4.3 성취기준

* **achievement\_standards** (PK `standard_id`, UNIQUE `standard_code`)

  * `standard_code`(예: 2수01-01), `level_id`, `domain_id`, `element_id(Nullable)`,
    `standard_title`, `standard_content`, `standard_order`
* **standard\_explanations** (PK `explanation_id`)

  * `standard_id`, `explanation_type`(성취기준 해설/적용시 고려사항/용어와 기호),
    `explanation_content`, `explanation_order`
* **standard\_achievement\_levels** (PK `sal_id`)

  * `standard_id`, `level_code(A~E)`, `level_description`
* **domain\_achievement\_levels** (PK `dal_id`)

  * `level_id`, `domain_id`, `level_code`, `category_id`, `level_description`
* **terms\_symbols** (PK `term_id`)

  * `level_id`, `domain_id`, `term_type(용어/기호)`, `term_name`, `term_description`, `latex_expression`

### 4.4 v1.3 확장(Edges & RAG)

* **standard\_terms**: 표준—용어 연결 (표준 본문에서 용어/기호 등장 연결)

  * `standard_id`, `term_id`, `relation_type(필수/참고)`, `method(rule/llm/human)`, `confidence`, `evidence_text`
* **representation\_types**: 표상 타입 마스터 (예: 수직선, 테이블, 그림 등)

  * `rep_type_code`, `rep_type_name`, `description`
* **standard\_representations**: 표준의 표현/표상

  * `standard_id`, `rep_type_id`, `representation_text(Nullable)`, `media_uri(Nullable)`, `method`, `confidence`
  * UNIQUE(`standard_id`, `rep_type_id`, `representation_text`)
* **context\_labels**: 문맥/상황 레이블(예: 실생활 맥락)
* **standard\_contexts**: 표준—문맥 매핑 (`standard_id`, `context_id`, `method`, `confidence`)
* **competencies**: 역량 마스터(예: 문제해결, 추론…)
* **standard\_competencies**: 표준—역량 매핑 (`standard_id`, `competency_id`, `weight`…)
* **achievement\_standard\_relations**: 표준 간 엣지

  * `from_standard_id` → `to_standard_id`, `relation_type('PREREQUISITE'|'HORIZONTAL')`, `method`, `confidence`, `evidence_text`

> 모든 테이블은 `created_at`, `updated_at`을 가지며, 업데이트 트리거로 `updated_at`이 자동 갱신됩니다.

### 4.5 인덱스(발췌)

* 본문/설명 전문검색: `to_tsvector('simple', ...)`에 대한 GIN 인덱스

  * `idx_achievement_standards_content_search`
  * `idx_terms_symbols_name_search`
  * `idx_standard_achievement_levels_search`
* 조인 키/룩업용: 각 FK/코드 컬럼에 BTree 인덱스

---

## 5. 뷰(Views)

* **v\_achievement\_standards\_detail**: 표준 + 학년군/영역 + 내용요소
* **v\_standard\_achievement\_levels\_detail**: 표준별 A\~E 성취수준 상세
* **v\_domain\_achievement\_levels\_detail**: 학년군×영역×범주 수준 설명
* **v\_terms\_symbols\_detail**: 용어/기호 상세(LaTeX 포함)
* **v\_curriculum\_statistics**: 학년군×영역 단위 통계(표준/요소/용어/수준 수)
* **v\_std\_in\_area**: 영역별 표준 목록
* **v\_std\_in\_category**: 범주별 표준 목록
* **v\_domain\_coreideas**: 영역별 핵심 아이디어
* **v\_standard\_levels**: `standard_code` 기준 A\~E 성취수준 뷰
* **v\_level\_alignment**: 표준—내용요소—범주 정합성 확인용
* **v\_standard\_meta**: 표준 메타(표상/문맥/역량 등) 요약
* **v\_term\_candidates**: 본문에서 추출한 표준—용어 연결 **후보**(히트수/샘플)
* **v\_horizontal\_suggestions**: 수평 관계 **후보**(동일 난이도/공통어휘 등)
* **v\_prerequisite\_suggestions**: 선행 관계 **후보**(번호/어휘/문장 패턴 기반)
* **rpt\_coverage**: 데이터 채움 정도 리포트(결손 탐지)
* **rpt\_dag\_health**: 선행 그래프 DAG 건전성 요약(사이클 유무 등)

---

## 6. 함수(Functions)

* **search\_achievement\_standards(search\_term text)**
  표준 본문 전문 검색(랭크 반환)
* **search\_achievement\_levels(search\_term text)**
  성취수준 설명 전문 검색(랭크 반환)
* **get\_standard\_levels(p\_standard\_code varchar)**
  특정 표준의 A\~E 성취수준 일괄 조회
* **detect\_prerequisite\_cycles()**
  선행(PREREQUISITE) 그래프의 사이클 탐지(행이 나오면 사이클 존재)
* **update\_updated\_at\_column()**
  트리거용 `updated_at` 자동 갱신 함수

---

## 7. 권한(roles)

* **curriculum\_reader**: 스키마 `USAGE`, 모든 테이블/시퀀스 `SELECT`
* **curriculum\_writer**: `SELECT, INSERT, UPDATE, DELETE`, 시퀀스 `USAGE`
* **curriculum\_admin**: 스키마/테이블/시퀀스 **ALL PRIVILEGES**
* 예시 계정: `curriculum / curriculum` (init 스크립트 생성)

> 운영 환경에서는 앱 접속용으로 `reader` 또는 최소권한 계정을 권장합니다.

---

## 8. 데이터 로딩 (scripts/data\_load.py)

* 환경변수 예시

```
DB_HOST=127.0.0.1
DB_PORT=5432
DB_NAME=mathematics_curriculum
DB_USER=curriculum
DB_PASSWORD=curriculum
DB_SCHEMA=curriculum
```

* 동작 개요

  1. 기준 데이터 → 2) 핵심 아이디어 → 3) 내용 요소 → 4) 성취기준 → 5) 성취수준(A\~E) → 6) 해설/고려사항 → 7) 용어/기호 → 8) 시퀀스 보정(setval) → 9) 검증 리포트
* 재실행 안전: `ON CONFLICT`로 **덮어쓰기/보충**

---

## 9. 샘플 쿼리

```sql
-- 통계
SELECT * FROM curriculum.v_curriculum_statistics ORDER BY grade_range, domain_name;

-- 특정 성취기준의 성취수준 A~E
SELECT * FROM curriculum.v_standard_levels WHERE standard_code='2수02-01';

-- RAG 검색
SELECT * FROM curriculum.search_achievement_standards('분수') LIMIT 20;
SELECT * FROM curriculum.search_achievement_levels('규칙') LIMIT 20;

-- 엣지 제안 확인
SELECT * FROM curriculum.v_prerequisite_suggestions ORDER BY score DESC LIMIT 50;
SELECT * FROM curriculum.v_horizontal_suggestions ORDER BY score DESC LIMIT 50;

-- 선행관계 반영 예시 + 사이클 체크
INSERT INTO curriculum.achievement_standard_relations
(from_standard_id, to_standard_id, relation_type, method, confidence)
VALUES (101, 135, 'PREREQUISITE', 'human', 0.9)
ON CONFLICT DO NOTHING;

SELECT * FROM curriculum.detect_prerequisite_cycles();
```

---

## 10. 백업/복원

```bash
# 백업 (호스트)
docker exec curriculum-postgres pg_dump -U postgres -d mathematics_curriculum \
  -n curriculum -Fc > backup_$(date +%F).dump

# 복원 (새 컨테이너로 가져갈 때)
docker exec -i curriculum-postgres pg_restore -U postgres -d mathematics_curriculum \
  --clean --if-exists < backup_YYYY-MM-DD.dump
```

---

## 11. 문제 해결 (Troubleshooting)

* **Connection refused**: 컨테이너 상태 확인 `docker compose ps` / 로그 확인 / 포트 충돌 점검 / 방화벽 허용
* **permission denied for schema curriculum**: 계정 권한 재확인(roles), `SET search_path TO curriculum, public` 확인
* **duplicate key / unique conflict**: CSV 중복 또는 기존 데이터 존재 → 의도된 덮어쓰기 규칙 점검
* **CRLF 스크립트 오류**: `dos2unix` 적용 후 실행 권한(`chmod +x`) 확인
* **시퀀스 꼬임**: `data_load.py`의 setval 단계 또는 수동 setval 수행

---

## 12. 변경 이력

* **v1.2.0**: 기본 스키마/뷰/함수 및 성취수준 A\~E
* **v1.3.0**: 엣지(선행/수평), 표상, 문맥/역량 태깅, 표준—용어 연결, RAG 보조 뷰/리포트/사이클 탐지 추가

---

## 부록 A. CSV ↔ 테이블 매핑(발췌)

* `reference/school_levels.csv` → `school_levels(school_type, grade_range, grade_start, grade_end, level_code)`
* `reference/domains.csv` → `domains(domain_id?, domain_name, domain_order, domain_code, description)`
* `reference/categories.csv` → `categories(category_id?, category_name, category_order, description)`
* `content_system/core_ideas.csv` → `core_ideas(idea_id, domain_id, idea_content, idea_order)`
* `content_system/content_elements_*.csv` → `content_elements(element_id? | [학년(군)/영역/범주], element_name, element_description, element_order)`
* `achievement_standards/achievement_standards_*.csv` → `achievement_standards(standard_id?, standard_code, level_id*, domain_id*, element_id?, standard_title, standard_content, standard_order)`
* `achievement_standards/standard_explanations_*.csv` → `standard_explanations(standard_id, explanation_type, explanation_content, explanation_order auto)`
* `achievement_levels/achievement_levels_*.csv` → `standard_achievement_levels(standard_id*, level_code, level_description)`
* `terms_symbols/terms_symbols_*.csv` → `terms_symbols(term_id? | [학년(군)/영역/구분/용어], term_description, latex_expression?)`

> `?`는 선택적 명시, `*`는 FK가 로더에서 코드 파싱/조인으로 자동 매핑됨을 의미합니다.

---

### 문의/확장

* 자동 엣지 반영 배치, 표상 일괄 업로드 템플릿, API 샘플(FastAPI) 등 추가가 필요하면 이 문서에 계속 보강해 드립니다.
